const faceConfig = new FaceEmotionalDetection({ faceDetector: 'tiny_face_detector' });
const videoEl = document.querySelector('#inputVideo')
const canvas = document.querySelector('#overlay')
const myDescriptor = [];

const me = JSON.parse(
    '[{"0":-0.07027743756771088,"1":0.056887187063694,"2":0.007232287898659706,"3":0.004222548566758633,"4":-0.09157819300889969,"5":0.0630534291267395,"6":-0.007151460275053978,"7":-0.05630805343389511,"8":0.1544445902109146,"9":-0.09172876924276352,"10":0.25273117423057556,"11":-0.05498648062348366,"12":-0.3275473117828369,"13":-0.029893912374973297,"14":0.0022366633638739586,"15":0.11038552224636078,"16":-0.11642143875360489,"17":-0.09016352146863937,"18":-0.12532813847064972,"19":-0.10504861921072006,"20":0.024209216237068176,"21":0.02017911896109581,"22":0.010875013656914234,"23":0.0379011407494545,"24":-0.11712773144245148,"25":-0.3078320026397705,"26":-0.05930359661579132,"27":-0.11651970446109772,"28":0.09857437014579773,"29":-0.09021846204996109,"30":-0.01475599966943264,"31":0.06807385385036469,"32":-0.15952293574810028,"33":-0.02150486223399639,"34":0.007952824234962463,"35":0.0590173713862896,"36":-0.09981685876846313,"37":-0.060264911502599716,"38":0.27306973934173584,"39":0.01648976095020771,"40":-0.1639605611562729,"41":-0.011926345527172089,"42":-0.02466391772031784,"43":0.30661439895629883,"44":0.15086247026920319,"45":0.04834301769733429,"46":-0.001420721411705017,"47":-0.04684656113386154,"48":0.13074183464050293,"49":-0.34463030099868774,"50":0.07214069366455078,"51":0.19781866669654846,"52":0.15538719296455383,"53":0.12038057297468185,"54":0.06585229188203812,"55":-0.19490870833396912,"56":0.04748104512691498,"57":0.11487477272748947,"58":-0.21475383639335632,"59":0.06648824363946915,"60":0.021576587110757828,"61":-0.06559975445270538,"62":-0.0356752946972847,"63":-0.1055389940738678,"64":0.25198814272880554,"65":0.149684339761734,"66":-0.09611837565898895,"67":-0.15506510436534882,"68":0.223440021276474,"69":-0.1645689308643341,"70":-0.06603207439184189,"71":0.1412888914346695,"72":-0.11303556710481644,"73":-0.2059342861175537,"74":-0.2253587394952774,"75":0.06796885281801224,"76":0.4585795998573303,"77":0.1922810822725296,"78":-0.1972920298576355,"79":0.011236850172281265,"80":-0.06758958846330643,"81":-0.05903783440589905,"82":0.07925499230623245,"83":0.039148036390542984,"84":-0.07896389067173004,"85":-0.05101613327860832,"86":-0.052080102264881134,"87":-0.007717680186033249,"88":0.2211504578590393,"89":-0.06634847819805145,"90":-0.050118669867515564,"91":0.24382363259792328,"92":0.05530720204114914,"93":0.035170264542102814,"94":0.059001531451940536,"95":-0.011849792674183846,"96":-0.03260529786348343,"97":-0.0028522899374365807,"98":-0.11590120196342468,"99":0.005572255700826645,"100":0.03610968589782715,"101":-0.15929703414440155,"102":0.028396323323249817,"103":0.05324395000934601,"104":-0.22594721615314484,"105":0.26088598370552063,"106":0.008083272725343704,"107":-0.012176601216197014,"108":0.03327781334519386,"109":0.016006840392947197,"110":-0.11510998010635376,"111":0.04888598248362541,"112":0.2325083613395691,"113":-0.36816149950027466,"114":0.2596728205680847,"115":0.16845789551734924,"116":0.07156787067651749,"117":0.16080424189567566,"118":0.03706382215023041,"119":0.10878816992044449,"120":0.0009405571036040783,"121":-0.034993115812540054,"122":-0.22226591408252716,"123":-0.13715045154094696,"124":0.060885436832904816,"125":-0.055423617362976074,"126":-0.029447391629219055,"127":0.055800359696149826},{"0":-0.009680814109742641,"1":0.11813376098871231,"2":0.010362982749938965,"3":-0.06631147861480713,"4":-0.09776031225919724,"5":0.13396281003952026,"6":-0.03840827941894531,"7":-0.07526028901338577,"8":0.19062024354934692,"9":-0.1562304049730301,"10":0.2256910651922226,"11":0.005085849203169346,"12":-0.26743197441101074,"13":-0.009903649799525738,"14":0.007382835261523724,"15":0.1426047384738922,"16":-0.03743109852075577,"17":-0.09987206757068634,"18":-0.10906237363815308,"19":-0.06462003290653229,"20":0.022087305784225464,"21":0.09672588109970093,"22":-0.0513424314558506,"23":-0.0010158810764551163,"24":-0.08292022347450256,"25":-0.3286234438419342,"26":-0.06093255430459976,"27":-0.09526438266038895,"28":0.05485614016652107,"29":-0.07375332713127136,"30":-0.0520719438791275,"31":0.018911093473434448,"32":-0.07498782128095627,"33":-0.01767870783805847,"34":0.04834733158349991,"35":0.09133921563625336,"36":-0.1719803512096405,"37":-0.010102026164531708,"38":0.24573643505573273,"39":0.052864428609609604,"40":-0.17238929867744446,"41":0.009837333112955093,"42":0.01984759047627449,"43":0.2924453616142273,"44":0.095960333943367,"45":0.057597484439611435,"46":0.0845114067196846,"47":-0.026582282036542892,"48":0.12749968469142914,"49":-0.28953149914741516,"50":0.09421876817941666,"51":0.13893386721611023,"52":0.18146738409996033,"53":0.12402225285768509,"54":0.08229181915521622,"55":-0.15118032693862915,"56":-0.00009716115891933441,"57":0.09776244312524796,"58":-0.21803629398345947,"59":0.12026415765285492,"60":0.13424333930015564,"61":-0.131774440407753,"62":-0.10660812258720398,"63":-0.05823114141821861,"64":0.2496955692768097,"65":0.12559641897678375,"66":-0.13886676728725433,"67":-0.17046895623207092,"68":0.1804421842098236,"69":-0.17758989334106445,"70":-0.10492102056741714,"71":0.05971573293209076,"72":-0.10895145684480667,"73":-0.14922915399074554,"74":-0.25849777460098267,"75":0.06727106124162674,"76":0.40889668464660645,"77":0.18257735669612885,"78":-0.13516423106193542,"79":-0.017879610881209373,"80":-0.027947135269641876,"81":0.0013028301764279604,"82":0.06054142490029335,"83":0.03665636107325554,"84":-0.04443465173244476,"85":-0.05296577513217926,"86":-0.03028119169175625,"87":-0.021947618573904037,"88":0.20968924462795258,"89":-0.06911676377058029,"90":-0.028680330142378807,"91":0.18647833168506622,"92":0.03955060988664627,"93":0.059678755700588226,"94":-0.013273256830871105,"95":0.05718022584915161,"96":-0.07193298637866974,"97":-0.06618290394544601,"98":-0.06698735058307648,"99":0.028210971504449844,"100":-0.022756723687052727,"101":-0.13977989554405212,"102":0.050985708832740784,"103":0.09587609767913818,"104":-0.2225215584039688,"105":0.30211809277534485,"106":-0.056752078235149384,"107":0.011557882651686668,"108":0.0474233403801918,"109":0.08521633595228195,"110":-0.14131827652454376,"111":-0.02660462260246277,"112":0.21041812002658844,"113":-0.2676609754562378,"114":0.16976037621498108,"115":0.1729305386543274,"116":0.06260448694229126,"117":0.11142420023679733,"118":0.08761757612228394,"119":0.09233058989048004,"120":0.010087249800562859,"121":-0.015780514106154442,"122":-0.2693408131599426,"123":-0.18764859437942505,"124":-0.00268753245472908,"125":-0.029860317707061768,"126":-0.021158285439014435,"127":0.06587138772010803},{"0":-0.05431216210126877,"1":0.09792138636112213,"2":-0.003358965739607811,"3":-0.053946204483509064,"4":-0.09924102574586868,"5":0.1180962547659874,"6":-0.0245850570499897,"7":-0.06242860108613968,"8":0.202209010720253,"9":-0.1760050654411316,"10":0.21806316077709198,"11":-0.017066016793251038,"12":-0.31879723072052,"13":-0.019113756716251373,"14":0.04001827538013458,"15":0.12301956117153168,"16":-0.0650881752371788,"17":-0.08424175530672073,"18":-0.08544918149709702,"19":-0.07006486505270004,"20":0.02392328716814518,"21":0.0818905383348465,"22":-0.030992062762379646,"23":-0.00531906820833683,"24":-0.07662954926490784,"25":-0.33389759063720703,"26":-0.04688137397170067,"27":-0.07350800931453705,"28":0.05754650756716728,"29":-0.09243926405906677,"30":-0.024594714865088463,"31":0.0877954289317131,"32":-0.06324389576911926,"33":-0.002637771889567375,"34":0.03598131239414215,"35":0.1220465898513794,"36":-0.16142013669013977,"37":0.02395929954946041,"38":0.2542755603790283,"39":0.02829558402299881,"40":-0.1904398798942566,"41":-0.01819317601621151,"42":-0.008083929307758808,"43":0.28842693567276,"44":0.10616223514080048,"45":0.060006555169820786,"46":0.040010735392570496,"47":-0.04834819585084915,"48":0.11774874478578568,"49":-0.279951810836792,"50":0.07549312710762024,"51":0.17402327060699463,"52":0.16119734942913055,"53":0.09731626510620117,"54":0.0738733559846878,"55":-0.1719052940607071,"56":-0.002810530364513397,"57":0.049872417002916336,"58":-0.2122879922389984,"59":0.08117306977510452,"60":0.14307545125484467,"61":-0.1374157965183258,"62":-0.08177243173122406,"63":-0.04397554695606232,"64":0.21844196319580078,"65":0.09939028322696686,"66":-0.12334830313920975,"67":-0.1746716946363449,"68":0.20641687512397766,"69":-0.18465730547904968,"70":-0.09081298112869263,"71":0.11059790849685669,"72":-0.11164750903844833,"73":-0.18409699201583862,"74":-0.21946248412132263,"75":0.054913703352212906,"76":0.4041486084461212,"77":0.18043801188468933,"78":-0.10800114274024963,"79":-0.005419902503490448,"80":-0.018688499927520752,"81":-0.04113193228840828,"82":0.08398818224668503,"83":0.061325084418058395,"84":-0.04881875589489937,"85":-0.06554140895605087,"86":-0.025339603424072266,"87":0.0009285062551498413,"88":0.18946845829486847,"89":-0.0649452656507492,"90":-0.05743490159511566,"91":0.17877890169620514,"92":0.07031399011611938,"93":0.07934030890464783,"94":0.009274357929825783,"95":0.022982005029916763,"96":-0.036937303841114044,"97":-0.040933892130851746,"98":-0.11688382923603058,"99":0.011861445382237434,"100":-0.02003106102347374,"101":-0.1589863896369934,"102":0.04817870259284973,"103":0.08316679298877716,"104":-0.18601389229297638,"105":0.3117891550064087,"106":-0.01815362647175789,"107":0.011691502295434475,"108":0.035142529755830765,"109":0.08682794868946075,"110":-0.15106043219566345,"111":-0.0046416958793997765,"112":0.2080976814031601,"113":-0.29142820835113525,"114":0.1854971945285797,"115":0.16756951808929443,"116":0.08568327873945236,"117":0.12916818261146545,"118":0.0908375084400177,"119":0.10973343253135681,"120":0.03696181997656822,"121":-0.028976723551750183,"122":-0.2517962157726288,"123":-0.1705787181854248,"124":0.007074453867971897,"125":-0.011924061924219131,"126":-0.003475632518529892,"127":0.05764394998550415}]'
);
const ivan = new Float32Array([-0.11798512190580368, 0.11441299319267273, 0.010506094433367252, -0.05242843180894852, -0.15199431777000427, -0.037362340837717056, -0.003405260853469372, -0.1263204663991928, 0.14415952563285828, -0.07087571173906326, 0.164301797747612, 0.0188029482960701, -0.2255450338125229, 0.00898517295718193, -0.01282226201146841, 0.09156325459480286, -0.12675981223583221, -0.12581773102283478, -0.10807938128709793, -0.0923713892698288, 0.0442366898059845, 0.026200562715530396, 0.05279034003615379, 0.09454547613859177, -0.15675263106822968, -0.25954046845436096, -0.08894198387861252, -0.1018589660525322, -0.0028406865894794464, -0.07749631255865097, 0.02342577651143074, 0.056815262883901596, -0.17322394251823425, -0.014120103791356087, 0.03342512249946594, 0.050734758377075195, -0.07246970385313034, -0.06188100576400757, 0.24702714383602142, 0.11521785706281662, -0.15273186564445496, 0.0031847013160586357, -0.009653565473854542, 0.36846479773521423, 0.19434355199337006, 0.0014443853870034218, 0.0398525595664978, -0.026711927726864815, 0.15942466259002686, -0.3759395480155945, 0.08378740400075912, 0.1934615671634674, 0.04280907288193703, 0.06835134327411652, 0.1062261238694191, -0.16247688233852386, 0.06682317703962326, 0.1225050687789917, -0.17878301441669464, 0.12153870612382889, 0.06788051873445511, -0.07921621203422546, -0.06600640714168549, -0.10839179903268814, 0.2312428206205368, 0.1528344303369522, -0.10356070846319199, -0.11784929037094116, 0.13293591141700745, -0.15195268392562866, -0.08203060179948807, 0.10676964372396469, -0.17126408219337463, -0.23827041685581207, -0.22305066883563995, 0.10161551088094711, 0.46668365597724915, 0.2596280872821808, -0.20448711514472961, -0.01429603062570095, -0.10281778872013092, 0.018819307908415794, 0.09878376126289368, 0.061587486416101456, -0.02286536619067192, -0.030688025057315826, -0.09584128856658936, 0.018810465931892395, 0.22816891968250275, -0.0657743290066719, -0.06774644553661346, 0.31744077801704407, 0.06177423894405365, -0.007392624393105507, 0.01854667067527771, -0.025161676108837128, -0.08193778991699219, -0.03822528198361397, -0.14758771657943726, -0.024806387722492218, 0.007046477869153023, -0.09951823949813843, -0.012964635156095028, 0.08589038252830505, -0.23107488453388214, 0.1749102622270584, -0.01921912655234337, -0.05829925835132599, -0.08113408833742142, -0.033128004521131516, -0.14733654260635376, -0.008099127560853958, 0.15647448599338531, -0.2801372706890106, 0.2242364138364792, 0.2232460379600525, 0.04208157956600189, 0.15348857641220093, 0.023363996297121048, 0.03853331506252289, 0.02387421578168869, 0.0029458235949277878, -0.06881378591060638, -0.09347491711378098, 0.07259637117385864, -0.0019651250913739204, -0.04920774698257446, -0.0030023360159248114]);
let dec = [], tmp = []
for (let i = 0; i < me.length; i++) {
    for (const [key, value] of Object.entries(me[i])) {
        tmp[key] = value;
    }
    dec.push(new Float32Array(tmp))
}

const labeledDescriptors = [
    new faceapi.LabeledFaceDescriptors(
        'Andrij Tymchenko',
        [...dec]
    ),
    new faceapi.LabeledFaceDescriptors(
        'Ыван Вікторочик Шпак',
        [ivan]
    )
]

const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors)

async function onPlay() {

    if (videoEl.paused || videoEl.ended || !faceConfig.isLoaded)
        return setTimeout(() => onPlay())

    const result = await faceapi
        .detectAllFaces(videoEl, faceConfig.faceDetectorConfig)
        .withFaceLandmarks()
        .withFaceDescriptors()
        .withFaceExpressions()

    if (result) {
        const dims = faceapi.matchDimensions(canvas, videoEl, true)
        const resizedResults = faceapi.resizeResults(result, dims)

        resizedResults.forEach(({ detection, descriptor }) => {
            const label = faceMatcher.findBestMatch(descriptor).toString()
            const options = { label }
            const drawBox = new faceapi.draw.DrawBox(detection.box, options)
            drawBox.draw(canvas)
        })

        // const minConfidence = 0.01
        // faceapi.draw.drawDetections(canvas, resizeResult)
        //faceapi.draw.drawLabels(canvas, resizeResult)
        // faceapi.draw.drawFaceExpressions(canvas, resizeResult, minConfidence)
    }

    setTimeout(() => onPlay())
}


async function run() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
    faceapi.env.monkeyPatch({
        Canvas: HTMLCanvasElement,
        Image: HTMLImageElement,
        ImageData: ImageData,
        Video: HTMLVideoElement,
        createCanvasElement: () => document.createElement('canvas'),
        createImageElement: () => document.createElement('img')
    })
    videoEl.srcObject = stream
    videoEl.play();
    onPlay()
}
run()